---
phase: 08-payment-integration
plan: 02
type: execute
wave: 2
depends_on:
  - 08-01
files_modified:
  - src/app/api/webhooks/ccbill/route.ts
  - src/actions/payment.ts
  - src/app/(protected)/subscribe/page.tsx
  - src/app/(protected)/subscribe/success/page.tsx
  - src/app/(protected)/subscribe/failure/page.tsx
  - src/proxy.ts
autonomous: false
requirements:
  - INFR-03

must_haves:
  truths:
    - "CCBill webhook events reach our server and update subscription state"
    - "User can initiate a payment flow from the subscribe page"
    - "User sees confirmation after successful payment"
    - "User sees a retry option after failed payment"
    - "Users without active subscription are redirected to subscribe page from session routes"
  artifacts:
    - path: "src/app/api/webhooks/ccbill/route.ts"
      provides: "Webhook POST endpoint for CCBill"
      exports: ["POST"]
    - path: "src/actions/payment.ts"
      provides: "Server actions for checkout initiation and status check"
      exports: ["initiateCheckout", "checkSubscriptionStatus"]
    - path: "src/app/(protected)/subscribe/page.tsx"
      provides: "Subscribe page with pricing and checkout CTA"
      min_lines: 30
    - path: "src/proxy.ts"
      provides: "Extended route protection with subscription gating"
      contains: "subscription-active"
  key_links:
    - from: "src/app/api/webhooks/ccbill/route.ts"
      to: "src/lib/payment/webhook-handler.ts"
      via: "delegates to handleWebhookEvent"
      pattern: "handleWebhookEvent"
    - from: "src/actions/payment.ts"
      to: "src/lib/payment/checkout.ts"
      via: "generates checkout URL then redirects"
      pattern: "generateCheckoutUrl"
    - from: "src/proxy.ts"
      to: "subscription-active cookie"
      via: "checks subscription cookie for session route access"
      pattern: "subscription-active"
    - from: "src/app/(protected)/subscribe/page.tsx"
      to: "src/actions/payment.ts"
      via: "form action calls initiateCheckout"
      pattern: "initiateCheckout"
---

<objective>
Wire the payment module to the application: webhook API endpoint, server actions for checkout, subscribe/success/failure pages, and proxy.ts subscription gating for session routes.

Purpose: Completes the payment integration so users can subscribe, CCBill can notify us of payment events, and session access is gated behind active subscription.
Output: Working payment flow from subscribe page through CCBill and back, with subscription-based access control.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-payment-integration/08-RESEARCH.md
@.planning/phases/08-payment-integration/08-01-SUMMARY.md
@src/proxy.ts
@src/lib/payment/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook endpoint and payment server actions</name>
  <files>src/app/api/webhooks/ccbill/route.ts, src/actions/payment.ts</files>
  <action>
    **Webhook endpoint (src/app/api/webhooks/ccbill/route.ts):**
    - Import `NextRequest`, `NextResponse` from "next/server"
    - Import `handleWebhookEvent` from "@/lib/payment"
    - Export `async function POST(request: NextRequest)`:
      1. Parse body as JSON with try/catch (return 400 on parse failure)
      2. Call `handleWebhookEvent(body)`
      3. If result.success, return `NextResponse.json({ status: "ok" })` with status 200
      4. If result.error, return `NextResponse.json({ error: result.error })` with status 400
      5. Wrap entire handler in try/catch, return 500 on unexpected error with generic message (never leak internals)
    - This endpoint must NOT require authentication — CCBill posts to it directly. The webhook handler internally verifies authenticity.

    **Server actions (src/actions/payment.ts):**
    - `"use server"` directive
    - Import auth from "@/lib/auth", redirect from "next/navigation"
    - Import `generateCheckoutUrl` from "@/lib/payment"
    - Import `getSubscriptionStatus` from "@/lib/payment"
    - Import cookies from "next/headers"

    Export `async function initiateCheckout()`:
      1. Get session via `auth()`. If no session/user, throw error "Not authenticated"
      2. Build origin from headers: `const origin = headers().get("x-forwarded-proto") + "://" + headers().get("host")` or fallback to `process.env.AUTH_URL || "http://localhost:3000"`
      3. Call `generateCheckoutUrl(session.user.id, origin)`
      4. Use `redirect(checkoutUrl)` to send user to CCBill

    Export `async function checkSubscriptionStatus()`:
      1. Get session via `auth()`. If no session, return { status: "none" as const }
      2. Call `getSubscriptionStatus(session.user.id)`
      3. If status === "active", set `subscription-active` cookie (httpOnly: false, path: "/", maxAge: 86400 — 24 hours). This enables the proxy.ts optimistic check (same pattern as consent-complete cookie).
      4. Return { status }
  </action>
  <verify>
    - `npm run build` succeeds
    - Webhook route exists at src/app/api/webhooks/ccbill/route.ts with POST export
    - Server actions exist in src/actions/payment.ts with "use server" directive
    - TypeScript compiles with no errors
  </verify>
  <done>
    Webhook endpoint receives CCBill POST events and delegates to handleWebhookEvent. Server actions enable checkout redirect and subscription status checks with cookie-based caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create subscribe pages and extend proxy.ts with subscription gating</name>
  <files>src/app/(protected)/subscribe/page.tsx, src/app/(protected)/subscribe/success/page.tsx, src/app/(protected)/subscribe/failure/page.tsx, src/proxy.ts</files>
  <action>
    **Subscribe page (src/app/(protected)/subscribe/page.tsx):**
    - `export const dynamic = "force-dynamic"` (needs auth check)
    - Server component. Import auth from "@/lib/auth", redirect from "next/navigation"
    - Import `getSubscriptionStatus` from "@/lib/payment"
    - Check auth, redirect to /login if not authenticated
    - Check subscription status — if already "active", redirect to /dashboard
    - Render a centered subscribe page matching the pink wellness theme:
      - Heading: "Unlock Your Wellness Journey"
      - Brief value proposition (2-3 lines about voice-guided sessions)
      - Pricing card with monthly subscription framing (price TBD — show placeholder "Monthly Subscription" without a specific dollar amount since pricing is configured in CCBill admin)
      - Form with `action={initiateCheckout}` and a submit button styled as primary CTA (bg-rose text matching existing theme)
      - Small print: "Secure payment processed by CCBill" and "Cancel anytime"
    - Import `initiateCheckout` from "@/actions/payment"

    **Success page (src/app/(protected)/subscribe/success/page.tsx):**
    - `export const dynamic = "force-dynamic"`
    - Client component ("use client") since it needs to poll for webhook processing
    - On mount, call `checkSubscriptionStatus()` server action every 2 seconds (up to 15 seconds) to handle the race condition where browser redirect arrives before webhook (Research Pitfall 2)
    - Show "Processing your payment..." with a spinner/pulse animation while waiting
    - Once status is "active", show success message: "Welcome! Your subscription is active." with a "Start a Session" link to /session and a "Go to Dashboard" link to /dashboard
    - If 15 seconds pass without activation, show: "Payment received! It may take a moment to activate. You can check your dashboard." with link to /dashboard
    - Use the pink wellness theme styling

    **Failure page (src/app/(protected)/subscribe/failure/page.tsx):**
    - Server component, `export const dynamic = "force-dynamic"`
    - Show empathetic message: "Something went wrong with your payment."
    - "Try Again" button linking back to /subscribe
    - "Back to Dashboard" link to /dashboard
    - Pink wellness theme styling

    **Proxy.ts extension (src/proxy.ts):**
    - Add `subscription-active` cookie check (same pattern as consent-complete)
    - Add `const isSubscribeRoute = pathname.startsWith("/subscribe")`
    - For session routes ONLY (not dashboard, not subscribe): if sessionCookie exists AND consentComplete exists BUT no `subscription-active` cookie, redirect to "/subscribe"
    - Subscribe routes should be accessible to authenticated users regardless of subscription status (they need to get to the subscribe page!)
    - Add "/subscribe/:path*" to the matcher array
    - Do NOT gate dashboard access behind subscription — dashboard is always accessible to authenticated+consented users. Only /session/* routes require subscription.
    - Keep existing auth and consent checks unchanged
  </action>
  <verify>
    - `npm run build` succeeds with all new pages properly categorized
    - Subscribe page renders at /subscribe
    - Success page renders at /subscribe/success
    - Failure page renders at /subscribe/failure
    - proxy.ts correctly redirects /session/* to /subscribe when subscription-active cookie is missing
    - proxy.ts does NOT redirect /dashboard to /subscribe
    - proxy.ts does NOT redirect /subscribe to /subscribe (infinite loop check)
  </verify>
  <done>
    Subscribe page shows pricing and checkout CTA. Success page polls for activation with race-condition handling. Failure page offers retry. Proxy.ts gates session routes behind active subscription cookie.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify payment integration flow</name>
  <files>n/a</files>
  <action>
    Human verification checkpoint. Claude has completed all payment integration work. User verifies:
    1. Run `npm run build` — should succeed with no errors
    2. Visit /subscribe while logged in — should see subscription page with pricing and CTA
    3. Visit /session while logged in without subscription — should redirect to /subscribe
    4. Visit /dashboard while logged in without subscription — should load normally (NOT gated)
    5. Verify /api/webhooks/ccbill endpoint exists (can test with curl POST of dummy JSON — should return 400 for invalid payload, not 401/403)
    6. Review subscribe page styling matches pink wellness theme
  </action>
  <verify>User confirms the payment flow is correctly wired by running through the verification steps above.</verify>
  <done>User types "approved" or describes issues to fix.</done>
</task>

</tasks>

<verification>
- Webhook endpoint accepts POST at /api/webhooks/ccbill without auth requirement
- Subscribe page shows pricing and initiates CCBill checkout on CTA click
- Success page handles webhook race condition with polling
- Failure page offers retry
- /session/* routes are gated behind subscription-active cookie
- /dashboard is NOT gated behind subscription
- /subscribe is accessible to authenticated users without subscription
- `npm run build` passes
</verification>

<success_criteria>
- Full payment flow wired: subscribe page -> CCBill redirect -> webhook -> subscription activation -> session access
- Subscription gating only applies to /session/* routes, not /dashboard
- Race condition between redirect and webhook handled via polling on success page
- All CCBill webhook event types handled (sale, renewal, cancellation, chargeback, refund)
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-payment-integration/08-02-SUMMARY.md`
</output>
