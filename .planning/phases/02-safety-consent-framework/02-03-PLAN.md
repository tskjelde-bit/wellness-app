---
phase: 02-safety-consent-framework
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/(protected)/verify-age/page.tsx
  - src/app/(protected)/accept-terms/page.tsx
  - src/app/(legal)/privacy/page.tsx
  - src/app/(legal)/terms/page.tsx
  - src/components/consent/age-gate.tsx
  - src/components/consent/tos-acceptance.tsx
  - src/components/consent/ai-disclosure.tsx
  - src/components/consent/sensory-consent.tsx
  - src/components/safety/crisis-banner.tsx
  - src/app/(protected)/dashboard/page.tsx
autonomous: true
requirements: [SAFE-01, SAFE-02, SAFE-03, SAFE-08]

must_haves:
  truths:
    - "User sees a DOB date input on /verify-age and cannot proceed without entering a date confirming they are 18+"
    - "User sees ToS and privacy policy links on /accept-terms and must check both acceptance boxes before proceeding"
    - "Privacy policy page at /privacy and terms page at /terms are accessible without authentication"
    - "AI disclosure component displays the full AI guide disclosure text"
    - "Sensory consent component shows a clear consent gate before body awareness content"
    - "Crisis banner displays 988 Lifeline and SAMHSA helpline information"
    - "Dashboard redirects users to /verify-age if consent is not complete"
  artifacts:
    - path: "src/app/(protected)/verify-age/page.tsx"
      provides: "Age verification gate page"
    - path: "src/app/(protected)/accept-terms/page.tsx"
      provides: "ToS and privacy acceptance page"
    - path: "src/app/(legal)/privacy/page.tsx"
      provides: "Privacy policy page"
    - path: "src/app/(legal)/terms/page.tsx"
      provides: "Terms of service page"
    - path: "src/components/consent/age-gate.tsx"
      provides: "DOB-based age verification form component"
    - path: "src/components/consent/tos-acceptance.tsx"
      provides: "ToS and privacy acceptance form component"
    - path: "src/components/consent/ai-disclosure.tsx"
      provides: "AI disclosure banner component"
      exports: ["AIDisclosure"]
    - path: "src/components/consent/sensory-consent.tsx"
      provides: "Body awareness consent gate component"
      exports: ["SensoryConsent"]
    - path: "src/components/safety/crisis-banner.tsx"
      provides: "Crisis helpline resources display"
      exports: ["CrisisBanner"]
  key_links:
    - from: "src/components/consent/age-gate.tsx"
      to: "src/actions/consent.ts"
      via: "useActionState calling verifyAge server action"
      pattern: "verifyAge"
    - from: "src/components/consent/tos-acceptance.tsx"
      to: "src/actions/consent.ts"
      via: "useActionState calling acceptTerms server action"
      pattern: "acceptTerms"
    - from: "src/app/(protected)/dashboard/page.tsx"
      to: "src/lib/consent/checks.ts"
      via: "getUserConsentStatus check and redirect"
      pattern: "getUserConsentStatus"
    - from: "src/components/consent/ai-disclosure.tsx"
      to: "src/lib/consent/constants.ts"
      via: "importing AI_DISCLOSURE_TEXT"
      pattern: "AI_DISCLOSURE_TEXT"
    - from: "src/components/safety/crisis-banner.tsx"
      to: "src/lib/consent/constants.ts"
      via: "importing HELPLINE_RESOURCES"
      pattern: "HELPLINE_RESOURCES"
---

<objective>
Build all consent and safety UI components, legal pages, and consent flow pages.

Purpose: Create the user-facing experience for age verification, ToS/privacy acceptance, AI disclosure, sensory consent, and crisis helpline display. These components consume the server actions and consent checks from Plan 01.

Output: Age verification page, ToS acceptance page, static legal pages (privacy, terms), AI disclosure component, sensory consent component, crisis banner component, and dashboard updated to enforce consent flow.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-consent-framework/02-RESEARCH.md
@.planning/phases/02-safety-consent-framework/02-01-SUMMARY.md

@src/actions/consent.ts
@src/lib/consent/checks.ts
@src/lib/consent/constants.ts
@src/components/auth/login-form.tsx
@src/components/auth/register-form.tsx
@src/app/(protected)/dashboard/page.tsx
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consent flow pages and form components</name>
  <files>
    src/app/(protected)/verify-age/page.tsx
    src/app/(protected)/accept-terms/page.tsx
    src/components/consent/age-gate.tsx
    src/components/consent/tos-acceptance.tsx
    src/app/(protected)/dashboard/page.tsx
  </files>
  <action>
**Create src/components/consent/age-gate.tsx:**

Client component ("use client") following the Phase 1 form component pattern (useActionState from React).

1. Import `verifyAge` from `@/actions/consent` and `useActionState` from `react`
2. Create a form with:
   - Heading: "Age Verification"
   - Explanatory text: "For your safety and legal compliance, we need to verify that you are 18 years or older."
   - A `<input type="date" name="dateOfBirth">` with appropriate label "Date of Birth"
   - Set the `max` attribute on the date input to today's date (preventing future dates)
   - Submit button: "Verify My Age"
   - Display error from state if present
   - On success (state.success === true), redirect to "/accept-terms" using `useRouter` from `next/navigation`
3. Style with Tailwind using the wellness theme: blush backgrounds, rose accent buttons, charcoal text. Match the visual style of login-form.tsx and register-form.tsx from Phase 1.
4. Use `useActionState(verifyAge, null)` to bind the server action.

**Create src/components/consent/tos-acceptance.tsx:**

Client component ("use client") following the same pattern.

1. Import `acceptTerms` from `@/actions/consent`
2. Create a form with:
   - Heading: "Terms & Privacy"
   - Explanatory text: "Please review and accept our terms of service and privacy policy before continuing."
   - Link to "/terms" (opens in new tab): "Read Terms of Service"
   - Link to "/privacy" (opens in new tab): "Read Privacy Policy"
   - Checkbox: "I accept the Terms of Service" (name="tosAccepted", value="true")
   - Checkbox: "I accept the Privacy Policy" (name="privacyAccepted", value="true")
   - Submit button: "Accept & Continue" (disabled until both checkboxes are checked -- use client-side state for this)
   - Display error from state if present
   - On success, redirect to "/dashboard" using `useRouter`
3. Style consistently with age-gate.tsx

**Create src/app/(protected)/verify-age/page.tsx:**

Server component page.

1. Import `auth` from `@/lib/auth` and `getUserConsentStatus` from `@/lib/consent`
2. Check if user is authenticated (auth()), redirect to /login if not
3. Check consent status: if already age-verified, redirect to `/accept-terms` (or `/dashboard` if all consents complete)
4. Render `<AgeGate />` component
5. Export `dynamic = "force-dynamic"` (same pattern as dashboard)
6. Add appropriate page metadata

**Create src/app/(protected)/accept-terms/page.tsx:**

Server component page.

1. Import `auth` and `getUserConsentStatus`
2. Check if user is authenticated, redirect to /login if not
3. Check consent status: if NOT age-verified, redirect to `/verify-age`. If already accepted ToS + privacy, redirect to `/dashboard`
4. Render `<TosAcceptance />` component
5. Export `dynamic = "force-dynamic"`

**Update src/app/(protected)/dashboard/page.tsx:**

Modify the existing dashboard to enforce consent flow:

1. After the existing `auth()` check, add a `getUserConsentStatus(session.user.id)` call
2. If `!consentStatus.allRequiredConsentsGiven`:
   - If `!consentStatus.ageVerified` -> redirect to `/verify-age`
   - Else if `!consentStatus.tosAccepted || !consentStatus.privacyAccepted` -> redirect to `/accept-terms`
3. Use `redirect()` from `next/navigation` for server-side redirects
4. Keep existing dashboard content for authenticated + consented users
  </action>
  <verify>
1. All 5 files exist and compile: `npx tsc --noEmit`
2. age-gate.tsx has "use client" directive and uses useActionState
3. tos-acceptance.tsx has "use client" directive and uses useActionState
4. verify-age/page.tsx exports `dynamic = "force-dynamic"`
5. accept-terms/page.tsx exports `dynamic = "force-dynamic"`
6. dashboard/page.tsx calls getUserConsentStatus and redirects if incomplete
7. `npm run build` succeeds
  </verify>
  <done>
Consent flow pages complete: /verify-age renders DOB-based age gate, /accept-terms renders ToS/privacy acceptance with links to legal pages. Dashboard enforces consent completion with server-side redirects. All forms use useActionState pattern consistent with Phase 1. Users cannot access dashboard or session content without completing all consent steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create legal pages, AI disclosure, sensory consent, and crisis banner components</name>
  <files>
    src/app/(legal)/privacy/page.tsx
    src/app/(legal)/terms/page.tsx
    src/components/consent/ai-disclosure.tsx
    src/components/consent/sensory-consent.tsx
    src/components/safety/crisis-banner.tsx
  </files>
  <action>
**Create src/app/(legal)/privacy/page.tsx:**

Static server component page -- accessible WITHOUT authentication.

1. Create a clean, readable privacy policy page with:
   - Title: "Privacy Policy"
   - Version: "Version 1.0 -- Last updated: [current date]"
   - Sections covering:
     - Information we collect (email, password hash, consent records, session timing metadata)
     - Information we do NOT collect (session transcripts, audio recordings, conversation content, date of birth -- SAFE-07 emphasis)
     - How we use your information (account management, consent verification, service improvement via anonymous metrics)
     - Data retention (account data: until deletion, consent records: permanent audit trail, session content: NEVER stored -- ephemeral by design)
     - Third-party services (OpenAI for content moderation and generation -- no user content stored by design)
     - Your rights (access, deletion, data portability)
     - Contact information (placeholder email)
   - Add a note at the bottom: "This privacy policy is a placeholder for legal review. Please consult with a legal professional before public launch."
2. Style with readable typography: max-w-2xl container, prose-like spacing, charcoal text on white/cream background
3. Add page metadata: title "Privacy Policy"

**Create src/app/(legal)/terms/page.tsx:**

Static server component page -- accessible WITHOUT authentication.

1. Create a clean, readable terms of service page with:
   - Title: "Terms of Service"
   - Version: "Version 1.0 -- Last updated: [current date]"
   - Sections covering:
     - Service description (AI-guided wellness and relaxation, NOT therapy or medical service)
     - Eligibility (must be 18+ years old)
     - AI disclosure (all guidance is AI-generated, not human)
     - Acceptable use (wellness and relaxation only, no misuse)
     - Content disclaimer (not a substitute for professional mental health care)
     - Limitation of liability (standard disclaimer)
     - Changes to terms (may update, version tracked in consent records)
   - Add a note: "These terms of service are a placeholder for legal review."
2. Style consistently with privacy page
3. Add page metadata: title "Terms of Service"

**Create src/components/consent/ai-disclosure.tsx:**

Follow Research Pattern 2 exactly.

1. Import `AI_DISCLOSURE_TEXT` from `@/lib/consent/constants`
2. Create a presentational component (no "use client" needed -- server component):
   - `role="alert"` and `aria-live="polite"` for accessibility
   - Heading: "AI Disclosure"
   - Body: `AI_DISCLOSURE_TEXT`
   - Style: rounded-lg, subtle background (blush/cream), charcoal text, clear typography
3. Export as `AIDisclosure`

**Create src/components/consent/sensory-consent.tsx:**

Client component ("use client") -- consent gate for body awareness content.

1. Import `recordSensoryConsent` from `@/actions/consent` and `useActionState` from `react`
2. Create a component that shows:
   - Heading: "Sensory Content Consent"
   - Explanatory text: "The next part of your session involves body awareness and sensory guidance. This may include references to physical sensations, breathing awareness, and gentle body-focused relaxation. You can skip this section at any time."
   - Two buttons: "I'm Ready" (submits the form with consent="true") and "Skip This Section" (triggers an onSkip callback prop)
   - The component accepts props: `onConsent?: () => void` and `onSkip?: () => void`
   - On form success, call onConsent callback
3. Style: centered, calm presentation, blush background, rose accent on consent button, muted style on skip button
4. Export as `SensoryConsent`

**Create src/components/safety/crisis-banner.tsx:**

Presentational component for displaying helpline resources.

1. Import `HELPLINE_RESOURCES` from `@/lib/consent/constants`
2. Create a component that displays:
   - A warm, non-alarming header: "Support Resources"
   - 988 Suicide & Crisis Lifeline: call/text 988, text HOME to 741741
   - SAMHSA National Helpline: 1-800-662-4357
   - Both with clickable tel: and https: links
   - Message: "These services are free, confidential, and available 24/7."
3. Style: soft background color (not alarming red), warm typography, accessible link styling
4. Make the phone numbers actual `<a href="tel:...">` links for mobile
5. Export as `CrisisBanner`
  </action>
  <verify>
1. All 5 files exist and compile: `npx tsc --noEmit`
2. /privacy page is accessible (no auth required -- it's under (legal) group)
3. /terms page is accessible (no auth required)
4. AIDisclosure component imports AI_DISCLOSURE_TEXT from consent/constants
5. SensoryConsent component uses useActionState with recordSensoryConsent
6. CrisisBanner component renders helpline phone numbers with tel: links
7. `npm run build` succeeds with all new routes showing in build output
  </verify>
  <done>
All consent UI components and legal pages complete. Privacy policy and terms of service pages are accessible without authentication. AI disclosure component shows full AI guide disclosure text. Sensory consent component provides a clear gate before body awareness content with consent/skip options. Crisis banner displays 988 Lifeline and SAMHSA helpline resources with clickable phone links. All components use the wellness theme styling (blush, rose, charcoal).
  </done>
</task>

</tasks>

<verification>
1. Full consent flow works: /verify-age -> /accept-terms -> /dashboard
2. Dashboard redirects to consent flow if any consent is missing
3. Legal pages (/privacy, /terms) accessible without login
4. AI disclosure component renders disclosure text
5. Sensory consent component has consent/skip options
6. Crisis banner shows clickable helpline numbers
7. All pages use force-dynamic where needed
8. `npm run build` succeeds
</verification>

<success_criteria>
- User encounters age verification at /verify-age with DOB input (SAFE-01)
- User sees AI disclosure component (SAFE-02)
- User encounters sensory consent gate before body awareness content (SAFE-03)
- Privacy policy and terms presented at /privacy and /terms, accepted at /accept-terms (SAFE-08)
- Crisis banner displays helpline resources (supports SAFE-06)
- Dashboard enforces complete consent flow before showing session content
- All components styled with wellness theme (blush, rose, charcoal)
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-consent-framework/02-03-SUMMARY.md`
</output>
