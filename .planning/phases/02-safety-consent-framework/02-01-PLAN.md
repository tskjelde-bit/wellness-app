---
phase: 02-safety-consent-framework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/env.ts
  - src/lib/session-store.ts
  - src/lib/consent/index.ts
  - src/lib/consent/checks.ts
  - src/lib/consent/constants.ts
  - src/actions/consent.ts
  - src/proxy.ts
autonomous: true
requirements: [SAFE-01, SAFE-02, SAFE-03, SAFE-07, SAFE-08]
user_setup:
  - service: openai
    why: "Moderation API (free) and future LLM generation (Phase 3)"
    env_vars:
      - name: OPENAI_API_KEY
        source: "OpenAI Dashboard -> API keys -> Create new secret key (https://platform.openai.com/api-keys)"

must_haves:
  truths:
    - "consent_records table exists in PostgreSQL with userId, consentType, consentGiven, consentVersion, recordedAt, metadata columns"
    - "users table has ageVerifiedAt, tosAcceptedAt, privacyAcceptedAt timestamp columns"
    - "Server actions record age verification, ToS acceptance, privacy acceptance, and sensory consent in both consent_records and users table"
    - "Consent check functions query users table and return structured ConsentStatus object"
    - "proxy.ts redirects unauthenticated users to /login and users without consent to /verify-age"
    - "SessionState interface includes consent flags (ageVerified, tosAccepted, sensoryConsentGiven, aiDisclosureShown)"
    - "OPENAI_API_KEY is validated by Zod env schema"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "consent_records table + user consent columns"
      contains: "consentRecordsTable"
    - path: "src/lib/consent/checks.ts"
      provides: "getUserConsentStatus function"
      exports: ["getUserConsentStatus", "ConsentStatus"]
    - path: "src/lib/consent/constants.ts"
      provides: "AI disclosure text, helpline resources, consent types"
      exports: ["AI_DISCLOSURE_TEXT", "HELPLINE_RESOURCES"]
    - path: "src/actions/consent.ts"
      provides: "Consent recording server actions"
      exports: ["verifyAge", "acceptTerms", "recordSensoryConsent"]
    - path: "src/proxy.ts"
      provides: "Extended route protection with consent enforcement"
  key_links:
    - from: "src/actions/consent.ts"
      to: "src/lib/db/schema.ts"
      via: "drizzle insert/update on consentRecordsTable and usersTable"
      pattern: "db\\.insert\\(consentRecordsTable\\)"
    - from: "src/lib/consent/checks.ts"
      to: "src/lib/db/schema.ts"
      via: "drizzle select on usersTable consent columns"
      pattern: "usersTable\\.ageVerifiedAt"
    - from: "src/proxy.ts"
      to: "consent-complete cookie"
      via: "cookie check for consent enforcement"
      pattern: "consent-complete"
---

<objective>
Build the consent data layer, server-side enforcement, and proxy protection for Phase 2.

Purpose: Establish the database schema (consent_records table, user consent columns), server actions for recording consent events, consent status checking functions, and proxy-level route protection -- all the backend infrastructure that consent UI components (Plan 03) will consume.

Output: Extended schema with migration, consent server actions, consent check functions, proxy.ts with consent enforcement, consent constants (AI disclosure text, helpline resources), extended SessionState interface.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-consent-framework/02-RESEARCH.md
@.planning/phases/01-project-scaffolding-data-layer/01-01-SUMMARY.md
@.planning/phases/01-project-scaffolding-data-layer/01-02-SUMMARY.md

@src/lib/db/schema.ts
@src/lib/env.ts
@src/lib/session-store.ts
@src/proxy.ts
@src/actions/auth.ts
@src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema with consent columns and consent_records table</name>
  <files>
    src/lib/db/schema.ts
    src/lib/env.ts
    src/lib/session-store.ts
  </files>
  <action>
**Schema changes in src/lib/db/schema.ts:**

1. Add `boolean` to the import from `drizzle-orm/pg-core`

2. Add three timestamp columns to `usersTable`:
   - `ageVerifiedAt: timestamp("age_verified_at", { mode: "date" })`
   - `tosAcceptedAt: timestamp("tos_accepted_at", { mode: "date" })`
   - `privacyAcceptedAt: timestamp("privacy_accepted_at", { mode: "date" })`

3. Create new `consentRecordsTable` (immutable audit log):
   ```
   id: uuid("id").defaultRandom().primaryKey()
   userId: uuid("user_id").notNull().references(() => usersTable.id, { onDelete: "cascade" })
   consentType: varchar("consent_type", { length: 50 }).notNull()
     // Values: "age_verification", "tos_acceptance", "privacy_acceptance", "sensory_content"
   consentGiven: boolean("consent_given").notNull()
   consentVersion: varchar("consent_version", { length: 20 }).notNull()
   recordedAt: timestamp("recorded_at", { mode: "date" }).defaultNow().notNull()
   metadata: text("metadata")
     // Optional JSON string for audit context (e.g., IP, user-agent)
   ```

4. Export `consentRecordsTable`

**Env validation in src/lib/env.ts:**

Add `OPENAI_API_KEY: z.string().min(1)` to the envSchema. This prepares the project for the moderation API (Plan 02) and LLM generation (Phase 3). The moderation API is free but requires an API key.

**SessionState extension in src/lib/session-store.ts:**

Extend the `SessionState` interface with consent flags:
```typescript
export interface SessionState {
  userId: string;
  createdAt: number;
  // Phase 2 consent flags
  ageVerified: boolean;
  tosAccepted: boolean;
  sensoryConsentGiven: boolean;
  aiDisclosureShown: boolean;
}
```

These flags are ephemeral Redis cache -- PostgreSQL is the source of truth (SAFE-07 compliant).

**Generate migration:**

Run `npx drizzle-kit generate` to create the SQL migration for the schema changes. Then verify the generated migration SQL looks correct (should add 3 columns to users, create consent_records table).

Do NOT run `drizzle-kit migrate` -- that requires a live database connection. Just generate the SQL.
  </action>
  <verify>
1. `npx drizzle-kit generate` succeeds and creates a new migration file in drizzle/
2. The generated SQL contains: ALTER TABLE "users" ADD COLUMN "age_verified_at", "tos_accepted_at", "privacy_accepted_at"
3. The generated SQL contains: CREATE TABLE "consent_records" with all specified columns
4. TypeScript compiles: `npx tsc --noEmit` passes (or at minimum, schema.ts has no type errors)
5. `consentRecordsTable` is exported from schema.ts
  </verify>
  <done>
Database schema extended with consent_records table and user consent timestamp columns. SessionState interface includes consent flags. OPENAI_API_KEY added to env validation. Migration SQL generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create consent server actions, check functions, constants, and extend proxy.ts</name>
  <files>
    src/lib/consent/index.ts
    src/lib/consent/checks.ts
    src/lib/consent/constants.ts
    src/actions/consent.ts
    src/proxy.ts
  </files>
  <action>
**Create src/lib/consent/constants.ts:**

Export these constants:
- `AI_DISCLOSURE_TEXT` -- Full disclosure string: "This is an AI guide. You are interacting with an artificial intelligence, not a human therapist or counselor. This experience is designed for relaxation and wellness purposes only and is not a substitute for professional mental health care."
- `HELPLINE_RESOURCES` -- Object with `crisis` (988 Lifeline: phone "988", text "Text HOME to 741741", url "https://988lifeline.org") and `samhsa` (phone "1-800-662-4357", url "https://www.samhsa.gov/find-help/national-helpline")
- `CONSENT_TYPES` -- Object: `{ AGE_VERIFICATION: "age_verification", TOS_ACCEPTANCE: "tos_acceptance", PRIVACY_ACCEPTANCE: "privacy_acceptance", SENSORY_CONTENT: "sensory_content" } as const`
- `CONSENT_VERSION` -- String "1.0" (current version of all consent documents)

**Create src/lib/consent/checks.ts:**

Export `ConsentStatus` interface and `getUserConsentStatus(userId: string)` function.

The function queries usersTable for ageVerifiedAt, tosAcceptedAt, privacyAcceptedAt columns and returns:
```typescript
interface ConsentStatus {
  ageVerified: boolean;
  tosAccepted: boolean;
  privacyAccepted: boolean;
  allRequiredConsentsGiven: boolean; // all three true
}
```

Follow the pattern from Research Pattern 9 exactly. Return all-false if user not found.

**Create src/lib/consent/index.ts:**

Barrel export: re-export everything from `./checks` and `./constants`.

**Create src/actions/consent.ts:**

Create three server actions following the `(_prevState, formData)` signature pattern from Phase 1:

1. `verifyAge` -- Accepts formData with "dateOfBirth" field. Validates with Zod that calculated age >= 18. Records in consent_records table AND updates usersTable.ageVerifiedAt. Does NOT store the actual DOB (data minimization per GDPR). Returns `{ success: true }` or `{ error: string }`. Follow Research Pattern 1 exactly.

2. `acceptTerms` -- Accepts formData with "tosAccepted" and "privacyAccepted" boolean fields (both must be "true"). Records TWO consent_records entries (one for ToS, one for privacy). Updates usersTable.tosAcceptedAt and privacyAcceptedAt. Returns `{ success: true }` or `{ error: string }`.

3. `recordSensoryConsent` -- Accepts formData with "consent" field ("true"). Records in consent_records table with type "sensory_content". Does NOT update a user column (sensory consent is per-session, not permanent). Returns `{ success: true }` or `{ error: string }`.

All three actions: call `auth()` to get session, verify user is authenticated, use drizzle `db.insert()` and `db.update()`.

After verifyAge and acceptTerms succeed, set a `consent-complete` cookie (value "1", httpOnly, secure in production, path "/", maxAge 7 days) so proxy.ts can do optimistic checks without hitting the database. Use `cookies()` from `next/headers` to set it. Set the cookie ONLY when all three consents are complete (check with getUserConsentStatus after recording).

**Extend src/proxy.ts:**

Add consent enforcement to the existing proxy:

1. Add route classifications:
   - `isSessionRoute = pathname.startsWith("/session")`
   - `isConsentRoute = pathname.startsWith("/verify-age") || pathname.startsWith("/accept-terms")`
   - `isLegalRoute = pathname.startsWith("/privacy") || pathname.startsWith("/terms")`

2. Add consent cookie check: `const consentComplete = request.cookies.get("consent-complete")`

3. Add logic: If user has session cookie but NO consent-complete cookie, and is trying to access /dashboard or /session routes (NOT consent or legal routes), redirect to /verify-age.

4. Update matcher to include: `/dashboard/:path*`, `/session/:path*`, `/login`, `/register`, `/verify-age`, `/accept-terms`

Keep existing auth redirect logic intact. Legal pages (/privacy, /terms) are accessible without authentication.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no type errors
2. All four files exist: src/lib/consent/index.ts, src/lib/consent/checks.ts, src/lib/consent/constants.ts, src/actions/consent.ts
3. src/proxy.ts has updated matcher array including /session, /verify-age, /accept-terms
4. `AI_DISCLOSURE_TEXT` and `HELPLINE_RESOURCES` are exported from consent/constants.ts
5. `getUserConsentStatus` is exported from consent/checks.ts
6. `verifyAge`, `acceptTerms`, `recordSensoryConsent` are exported from actions/consent.ts
7. `npm run build` succeeds (production build)
  </verify>
  <done>
Consent infrastructure complete: server actions record all consent types to PostgreSQL with audit trail, consent status checks query user state, proxy.ts enforces consent completion before session access, AI disclosure text and helpline resources defined as constants. No session transcripts stored anywhere (SAFE-07 compliant by design).
  </done>
</task>

</tasks>

<verification>
1. Database migration generated with consent_records table and user consent columns
2. All consent server actions compile and follow (_prevState, formData) pattern
3. Consent check function returns structured ConsentStatus
4. proxy.ts redirects unconsented users to /verify-age
5. Constants defined for AI disclosure, helpline resources, consent types
6. SessionState interface includes consent flags
7. OPENAI_API_KEY validated in env schema
8. `npm run build` succeeds
</verification>

<success_criteria>
- consent_records table schema defined with all required columns
- Users table has ageVerifiedAt, tosAcceptedAt, privacyAcceptedAt columns
- Three consent server actions work: verifyAge (DOB-based, 18+), acceptTerms (ToS + privacy), recordSensoryConsent
- getUserConsentStatus returns boolean flags for all consent types
- proxy.ts redirects to /verify-age when consent-complete cookie missing
- No session content or transcripts stored in any persistent store (SAFE-07)
- OPENAI_API_KEY in env validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-consent-framework/02-01-SUMMARY.md`
</output>
