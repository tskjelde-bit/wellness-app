---
phase: 05-session-state-machine-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/session/phase-machine.ts
  - src/lib/session/phase-prompts.ts
  - src/lib/session/phase-config.ts
  - src/lib/session/index.ts
autonomous: true
requirements:
  - SESS-01
  - SESS-02
  - SESS-05

must_haves:
  truths:
    - "5 session phases are defined in order: atmosphere, breathing, sensory, relaxation, resolution"
    - "Each phase has a distinct system prompt with unique tone, pacing, and content instructions"
    - "Resolution phase prompt explicitly includes grounding instructions (wiggle fingers/toes, notice room, open eyes)"
    - "Phase transitions are defined as forward-only (atmosphere->breathing->...->resolution, no branching)"
    - "Sentence budgets are configurable per session length (10, 15, 20, 30 minutes)"
  artifacts:
    - path: "src/lib/session/phase-machine.ts"
      provides: "SessionPhase type, SESSION_PHASES const, getNextPhase, isTerminalPhase, getPhaseIndex"
      exports: ["SESSION_PHASES", "SessionPhase", "getNextPhase", "isTerminalPhase", "getPhaseIndex"]
    - path: "src/lib/session/phase-prompts.ts"
      provides: "Per-phase system prompt templates and transition hints"
      exports: ["PHASE_PROMPTS", "TRANSITION_HINTS", "buildPhaseInstructions"]
    - path: "src/lib/session/phase-config.ts"
      provides: "Phase timing budgets per session length"
      exports: ["getSessionBudgets", "PhaseConfig", "PHASE_PROPORTIONS"]
    - path: "src/lib/session/index.ts"
      provides: "Barrel exports for session module"
  key_links:
    - from: "src/lib/session/phase-prompts.ts"
      to: "src/lib/session/phase-machine.ts"
      via: "imports SessionPhase type for Record keys"
      pattern: "import.*SessionPhase.*from.*phase-machine"
    - from: "src/lib/session/phase-config.ts"
      to: "src/lib/session/phase-machine.ts"
      via: "imports SessionPhase type for budget records"
      pattern: "import.*SessionPhase.*from.*phase-machine"
    - from: "src/lib/session/phase-prompts.ts"
      to: "src/lib/safety"
      via: "imports SAFETY_SYSTEM_PROMPT for combined instructions"
      pattern: "import.*SAFETY_SYSTEM_PROMPT.*from.*safety"
---

<objective>
Create the session phase state machine, per-phase prompt templates, and phase timing configuration that define the 5-phase wellness session flow.

Purpose: Establish the foundation types, phase definitions, prompt templates, and timing budgets that the SessionOrchestrator (Plan 02) and WebSocket handler (Plan 03) will consume. This is the domain model for structured sessions.

Output: Four new files in `src/lib/session/` providing typed phase definitions, rich prompt templates per phase, configurable sentence budgets, and barrel exports.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-session-state-machine-orchestration/05-RESEARCH.md

@src/lib/safety/constants.ts (SAFETY_SYSTEM_PROMPT for prompt composition)
@src/lib/llm/prompts.ts (SESSION_PROMPT persona instructions for prompt composition)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phase state machine with typed transitions</name>
  <files>src/lib/session/phase-machine.ts</files>
  <action>
Create `src/lib/session/phase-machine.ts` with the hand-rolled finite state machine for the 5-phase session flow:

1. Define `SESSION_PHASES` as a readonly const tuple: `["atmosphere", "breathing", "sensory", "relaxation", "resolution"]`
2. Derive `SessionPhase` type from the tuple: `type SessionPhase = (typeof SESSION_PHASES)[number]`
3. Define `TRANSITIONS` as a `Record<SessionPhase, SessionPhase | null>` mapping each phase to its successor (resolution maps to null as the terminal state)
4. Export `getNextPhase(current: SessionPhase): SessionPhase | null` -- returns the next phase from TRANSITIONS
5. Export `isTerminalPhase(phase: SessionPhase): boolean` -- returns true if TRANSITIONS[phase] === null
6. Export `getPhaseIndex(phase: SessionPhase): number` -- returns SESSION_PHASES.indexOf(phase)
7. Export `PhaseTransitionResult` interface with `from: SessionPhase`, `to: SessionPhase | null`, `isComplete: boolean`

This is a strictly linear FSM with no branching, no guards, and no parallel states. Do NOT use XState or any library -- a typed transitions table is ~30 lines and fully sufficient. See Research Pattern 1.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify exports: SESSION_PHASES, SessionPhase, getNextPhase, isTerminalPhase, getPhaseIndex, PhaseTransitionResult.</verify>
  <done>SessionPhase type and FSM utilities exist with forward-only transitions from atmosphere through resolution. TypeScript compilation passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create phase prompts, transition hints, timing config, and barrel exports</name>
  <files>
    src/lib/session/phase-prompts.ts
    src/lib/session/phase-config.ts
    src/lib/session/index.ts
  </files>
  <action>
**File 1: `src/lib/session/phase-prompts.ts`**

Create per-phase system prompt templates following Research Pattern 2 and Code Examples:

1. Import `SessionPhase` from `./phase-machine` and `SAFETY_SYSTEM_PROMPT` from `@/lib/safety` and `SESSION_PROMPT` from `@/lib/llm/prompts`
2. Define `PHASE_PROMPTS: Record<SessionPhase, string>` with rich, distinct prompts per phase:
   - **atmosphere**: Warm, welcoming. Invite listener to settle. Sensory language about safe space, warmth, soft light. 3-5 sentences. Moderate pacing.
   - **breathing**: Calm, rhythmic. Guide specific breathing patterns with counts. "Breathe in... and slowly out." 3-4 sentences. Slow pacing.
   - **sensory**: Intimate, descriptive. Body awareness -- warmth, weight, texture, tingling. "Notice how..." and "feel the..." phrases. 3-5 sentences. Slow to moderate.
   - **relaxation**: Very soft, almost whispered. Deep rest -- waves of calm, melting tension, floating. Minimal words. 2-4 sentences. Very slow.
   - **resolution**: Warm, grounding. MUST include specific grounding instructions: wiggle fingers and toes, notice room sounds, open eyes slowly. Affirm the experience. 3-5 sentences. Gradually increasing pace. DO NOT rush or use alarming language.
3. Define `TRANSITION_HINTS: Record<SessionPhase, string>` for wind-down cues injected when approaching phase budget limit. Each hint transitions toward the NEXT phase's topic. Resolution's hint is empty string (terminal). CRITICAL: Never use "end", "finish", or "final" in non-Resolution phase hints -- these cause premature session-ending language (Research Pitfall 4).
4. Export `buildPhaseInstructions(phase: SessionPhase, transitionHint?: string): string` that combines: SAFETY_SYSTEM_PROMPT + SESSION_PROMPT + "CURRENT PHASE: {phase}" + PHASE_PROMPTS[phase] + optional transition hint. Joined with "\n\n".

**File 2: `src/lib/session/phase-config.ts`**

Create phase timing budgets following Research Pattern 3:

1. Import `SessionPhase`, `SESSION_PHASES` from `./phase-machine`
2. Export `PhaseConfig` interface: `{ sentenceBudget: number; windDownAt: number }`
3. Export `PHASE_PROPORTIONS: Record<SessionPhase, number>` as fractions summing to 1.0: atmosphere 0.12, breathing 0.20, sensory 0.28, relaxation 0.25, resolution 0.15
4. Define `SENTENCES_PER_MINUTE = 13` (at ~4.5s per sentence)
5. Export `getSessionBudgets(sessionLengthMinutes: number): Record<SessionPhase, PhaseConfig>` that:
   - Calculates total sentences: `Math.round(sessionLengthMinutes * SENTENCES_PER_MINUTE)`
   - For each phase, calculates `sentenceBudget` from proportion * total (rounded)
   - Sets `windDownAt` to `sentenceBudget - Math.max(3, Math.round(sentenceBudget * 0.15))` (wind down in last ~15% of phase, minimum 3 sentences before end)
   - Returns the Record keyed by SessionPhase

**File 3: `src/lib/session/index.ts`**

Create barrel exports re-exporting all public APIs from the three session module files:
- From `./phase-machine`: SESSION_PHASES, SessionPhase, getNextPhase, isTerminalPhase, getPhaseIndex, PhaseTransitionResult
- From `./phase-prompts`: PHASE_PROMPTS, TRANSITION_HINTS, buildPhaseInstructions
- From `./phase-config`: getSessionBudgets, PhaseConfig, PHASE_PROPORTIONS
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify `buildPhaseInstructions("atmosphere")` returns a string containing "SAFETY", "wellness guide", and "CURRENT PHASE: ATMOSPHERE". Verify `getSessionBudgets(15)` returns an object with keys for all 5 phases and sentenceBudget values summing to approximately 195.</verify>
  <done>Phase prompts define distinct tone/content per phase, resolution includes grounding instructions, transition hints avoid premature ending language, timing budgets scale with session length. All exports available via `@/lib/session`.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All 5 SESSION_PHASES are defined in correct order
3. `getNextPhase("atmosphere")` returns "breathing", `getNextPhase("resolution")` returns null
4. `isTerminalPhase("resolution")` returns true, `isTerminalPhase("atmosphere")` returns false
5. Each phase in PHASE_PROMPTS has distinct content (no copy-paste templates)
6. Resolution prompt contains "wiggle", "fingers", "toes", "open eyes", "room" keywords
7. TRANSITION_HINTS for non-resolution phases do NOT contain "end", "finish", or "final"
8. `getSessionBudgets(15)` returns budgets summing to ~195 total sentences
9. `getSessionBudgets(10)` and `getSessionBudgets(30)` scale proportionally
</verification>

<success_criteria>
- SessionPhase type and FSM utilities provide typed, forward-only phase progression
- 5 distinct phase prompt templates with unique tone, pacing, and content instructions
- Resolution phase prompt includes specific grounding and return-to-awareness instructions
- Sentence budgets configurable per session length with wind-down thresholds
- All types and functions exported via barrel index at `@/lib/session`
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-session-state-machine-orchestration/05-01-SUMMARY.md`
</output>
