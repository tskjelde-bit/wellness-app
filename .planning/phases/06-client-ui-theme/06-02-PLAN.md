---
phase: 06-client-ui-theme
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - src/app/(protected)/session/page.tsx
  - src/components/session/breathing-orb.tsx
  - src/components/session/session-screen.tsx
  - src/hooks/use-session-ws.ts
autonomous: true
requirements:
  - UI-05
  - SESS-07

must_haves:
  truths:
    - "User can navigate to /session and see a Begin Session button"
    - "Clicking Begin Session connects WebSocket and starts audio playback"
    - "Active session shows breathing orb animation with minimal visual chrome"
    - "Current sentence text appears as a subtle overlay during playback"
    - "Session screen uses dark background for voice-first immersive experience"
    - "useSessionWebSocket exposes currentPhase from server phase_start/phase_transition messages"
  artifacts:
    - path: "src/app/(protected)/session/page.tsx"
      provides: "Session route page (client component wrapper)"
      contains: "SessionScreen"
    - path: "src/components/session/session-screen.tsx"
      provides: "Main session UI composing useSessionWebSocket hook"
      contains: "useSessionWebSocket"
    - path: "src/components/session/breathing-orb.tsx"
      provides: "Animated breathing visual for active sessions"
      contains: "animate-breathe"
    - path: "src/hooks/use-session-ws.ts"
      provides: "Extended hook with currentPhase state from phase_start/phase_transition messages"
      contains: "currentPhase"
  key_links:
    - from: "src/app/(protected)/session/page.tsx"
      to: "src/components/session/session-screen.tsx"
      via: "import and render"
      pattern: "import.*SessionScreen"
    - from: "src/components/session/session-screen.tsx"
      to: "src/hooks/use-session-ws.ts"
      via: "useSessionWebSocket hook"
      pattern: "useSessionWebSocket"
    - from: "src/components/session/session-screen.tsx"
      to: "src/components/session/breathing-orb.tsx"
      via: "import and render"
      pattern: "import.*BreathingOrb"
    - from: "src/components/session/session-screen.tsx"
      to: "/api/session/ws"
      via: "WebSocket connection through useSessionWebSocket.connect()"
      pattern: "connect\\(\\)"
---

<objective>
Build the voice-first session screen with breathing orb animation, connect-then-start flow, and extend useSessionWebSocket with phase tracking state.

Purpose: The session screen is the core user experience -- a minimal, immersive interface where voice IS the product and the screen is secondary. The breathing orb provides a calming visual anchor during audio playback. Extending the hook with phase tracking prepares for Phase 7's progress indicator without rework.

Output: Session page at /session, BreathingOrb component, SessionScreen component, updated useSessionWebSocket hook with currentPhase.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-client-ui-theme/06-RESEARCH.md
@.planning/phases/06-client-ui-theme/06-01-SUMMARY.md
@src/hooks/use-session-ws.ts
@src/hooks/use-audio-queue.ts
@src/lib/ws/message-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useSessionWebSocket with phase tracking and build breathing orb</name>
  <files>src/hooks/use-session-ws.ts, src/components/session/breathing-orb.tsx</files>
  <action>
**use-session-ws.ts** -- Add `currentPhase` state to track the active session phase. Minimal changes to existing hook:

1. Add state: `const [currentPhase, setCurrentPhase] = useState<string | null>(null);`
2. In the `ws.onmessage` handler's switch statement, add two new cases:
   ```typescript
   case "phase_start":
     setCurrentPhase(message.phase);
     break;
   case "phase_transition":
     setCurrentPhase(message.to);
     break;
   ```
3. In the `session_end` case, add `setCurrentPhase(null);` to reset phase state.
4. Add `currentPhase` to the return object alongside existing properties.

These are the ONLY changes to this file. Do NOT modify any other logic or signatures. The `ServerMessage` type already includes `phase_start` and `phase_transition` variants (verified in message-types.ts).

**breathing-orb.tsx** -- Create a new file at `src/components/session/breathing-orb.tsx`:

```tsx
"use client";

interface BreathingOrbProps {
  isPlaying: boolean;
}

export function BreathingOrb({ isPlaying }: BreathingOrbProps) {
  return (
    <div className="relative flex items-center justify-center">
      {/* Outer glow ring */}
      <div
        className={`absolute h-48 w-48 rounded-full bg-blush/20 ${
          isPlaying ? "animate-pulse-soft" : ""
        } motion-reduce:animate-none`}
      />
      {/* Inner breathing orb */}
      <div
        className={`h-32 w-32 rounded-full bg-gradient-to-br from-blush to-rose ${
          isPlaying ? "animate-breathe" : "opacity-70"
        } motion-reduce:animate-none`}
      />
    </div>
  );
}
```

Key details:
- Uses `animate-breathe` and `animate-pulse-soft` from the expanded @theme (Plan 01)
- `motion-reduce:animate-none` respects prefers-reduced-motion (Research Pitfall 5)
- When not playing, orb shows at opacity-70 (static, calm state)
- When playing, outer ring pulses and inner orb breathes (scale + opacity)
- Component is a client component (uses conditional className)
  </action>
  <verify>Read use-session-ws.ts and confirm `currentPhase` state exists, `phase_start` and `phase_transition` cases are in switch, and `currentPhase` is in return object. Read breathing-orb.tsx and confirm it uses `animate-breathe`, `animate-pulse-soft`, and `motion-reduce:animate-none`.</verify>
  <done>useSessionWebSocket returns `currentPhase` (string | null) that updates on phase_start/phase_transition server messages. BreathingOrb component renders animated orb with motion-reduce accessibility.</done>
</task>

<task type="auto">
  <name>Task 2: Create session page and session screen component</name>
  <files>src/app/(protected)/session/page.tsx, src/components/session/session-screen.tsx</files>
  <action>
**session-screen.tsx** -- Create at `src/components/session/session-screen.tsx`. This is the main session UI component:

```tsx
"use client";

import { useEffect, useState } from "react";
import { useSessionWebSocket } from "@/hooks/use-session-ws";
import { BreathingOrb } from "@/components/session/breathing-orb";
import Link from "next/link";

export function SessionScreen() {
  const {
    connect,
    startSession,
    endSession,
    isConnected,
    isPlaying,
    currentText,
    sessionId,
    currentPhase,
    error,
  } = useSessionWebSocket();

  const [hasInitiated, setHasInitiated] = useState(false);

  // User taps "Begin Session" -> connect (AudioContext + WS) in gesture handler
  const handleStart = () => {
    connect();
    setHasInitiated(true);
  };

  // Start session once WebSocket connection opens (Research Pitfall 3: race condition)
  useEffect(() => {
    if (hasInitiated && isConnected && !sessionId) {
      startSession();
    }
  }, [hasInitiated, isConnected, sessionId, startSession]);

  // Handle end session -- navigate back handled by session_end + user action
  const handleEnd = () => {
    endSession();
  };

  // ---- Pre-session: "Begin Session" screen ----
  if (!hasInitiated) {
    return (
      <div className="flex min-h-dvh flex-col items-center justify-center bg-charcoal safe-area-padding">
        <div className="flex flex-col items-center gap-8">
          <BreathingOrb isPlaying={false} />
          <div className="flex flex-col items-center gap-4">
            <button
              onClick={handleStart}
              className="flex min-h-[44px] items-center justify-center rounded-lg bg-rose px-8 py-3 font-medium text-white transition-colors hover:bg-rose-dark active:scale-[0.98]"
            >
              Begin Session
            </button>
            <Link
              href="/dashboard"
              className="text-sm text-cream/50 transition-colors hover:text-cream/70"
            >
              Back to Dashboard
            </Link>
          </div>
        </div>
      </div>
    );
  }

  // ---- Connecting state ----
  if (!isConnected && hasInitiated) {
    return (
      <div className="flex min-h-dvh flex-col items-center justify-center bg-charcoal safe-area-padding">
        <div className="animate-pulse text-cream/60 text-sm">Connecting...</div>
      </div>
    );
  }

  // ---- Active session: voice-first minimal chrome ----
  return (
    <div className="flex min-h-dvh flex-col items-center justify-center bg-charcoal safe-area-padding">
      {/* Error banner */}
      {error && (
        <div className="absolute top-4 left-4 right-4 rounded-lg bg-rose/20 p-3 text-center text-sm text-cream/80 animate-fade-in safe-area-padding">
          {error}
        </div>
      )}

      {/* Central breathing orb */}
      <BreathingOrb isPlaying={isPlaying} />

      {/* Current sentence text (subtle overlay) */}
      {currentText && (
        <p className="mt-8 max-w-sm px-4 text-center text-sm text-cream/60 animate-fade-in">
          {currentText}
        </p>
      )}

      {/* Minimal end session control at bottom */}
      <div className="absolute bottom-8 left-0 right-0 flex justify-center" style={{ paddingBottom: "env(safe-area-inset-bottom)" }}>
        <button
          onClick={handleEnd}
          className="text-xs text-cream/30 transition-colors hover:text-cream/60"
        >
          End Session
        </button>
      </div>
    </div>
  );
}
```

Key decisions per Research:
- `connect()` called directly in `onClick` handler (user gesture for AudioContext -- Research Pitfall 1)
- `startSession()` triggered via `useEffect` watching `isConnected` (race condition fix -- Research Pitfall 3)
- `min-h-dvh` instead of `min-h-screen` (mobile viewport -- Research Pitfall 2)
- `motion-reduce:animate-none` handled by BreathingOrb (Research Pitfall 5)
- End Session button is intentionally tiny/subtle -- voice-first, minimal chrome (UI-05)
- No navigation bar, no sidebar, no unnecessary chrome during active session (UI-05)
- `safe-area-padding` utility class for notched devices

**session/page.tsx** -- Create at `src/app/(protected)/session/page.tsx`:

```tsx
import { SessionScreen } from "@/components/session/session-screen";

export const dynamic = "force-dynamic";

export default function SessionPage() {
  return <SessionScreen />;
}
```

The page is inside `(protected)` route group so it inherits the proxy.ts auth protection. Uses `force-dynamic` to match the dashboard pattern (avoids build-time pre-rendering issues). The actual client logic lives in SessionScreen component.
  </action>
  <verify>Run `npx next build 2>&1 | tail -30` to confirm no build errors. Read session/page.tsx and confirm it imports SessionScreen. Read session-screen.tsx and confirm: imports useSessionWebSocket, imports BreathingOrb, has handleStart calling connect(), has useEffect for startSession after isConnected, uses min-h-dvh, has End Session button.</verify>
  <done>Session page at /session renders SessionScreen. SessionScreen shows pre-session state with Begin button, connecting state, and active session state with breathing orb, subtle text overlay, and minimal End Session control. Voice-first design with dark background and no navigation chrome.</done>
</task>

</tasks>

<verification>
1. `npx next build` completes without errors
2. useSessionWebSocket returns `currentPhase` in its API
3. BreathingOrb uses `animate-breathe` and `motion-reduce:animate-none`
4. SessionScreen calls `connect()` in click handler (user gesture for AudioContext)
5. SessionScreen uses `useEffect` to call `startSession()` after connection (race condition fix)
6. Session page is in `(protected)` route group at `/session`
7. Active session has only breathing orb, text overlay, and subtle end button (minimal chrome)
8. All layouts use `min-h-dvh` (not `min-h-screen`)
</verification>

<success_criteria>
- Voice-first session screen at /session with dark background and minimal visual chrome
- Breathing orb animates during playback, static when not playing
- connect-then-start flow handles AudioContext and WebSocket race condition correctly
- useSessionWebSocket tracks currentPhase for future Phase 7 progress indicator
- Full user flow works: Dashboard -> Start New Session -> /session -> Begin -> audio plays
</success_criteria>

<output>
After completion, create `.planning/phases/06-client-ui-theme/06-02-SUMMARY.md`
</output>
