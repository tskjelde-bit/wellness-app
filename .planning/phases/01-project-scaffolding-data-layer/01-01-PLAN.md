---
phase: 01-project-scaffolding-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - drizzle.config.ts
  - src/app/layout.tsx
  - src/app/page.tsx
  - src/app/globals.css
  - src/lib/db/index.ts
  - src/lib/db/schema.ts
  - src/lib/redis.ts
  - src/lib/session-store.ts
  - src/lib/env.ts
  - src/types/index.ts
  - .env.local
  - .env.example
  - .gitignore
autonomous: true
requirements:
  - INFR-04
  - INFR-05

user_setup:
  - service: neon
    why: "PostgreSQL database for user accounts and session metadata"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Project -> Connection Details -> Pooled connection string"
      - name: DATABASE_URL_UNPOOLED
        source: "Neon Console -> Project -> Connection Details -> Direct (unpooled) connection string"
    dashboard_config:
      - task: "Create a Neon project"
        location: "https://console.neon.tech -> New Project -> select us-east-1 region"
  - service: upstash
    why: "Redis session state store with TTL-based auto-expiry"
    env_vars:
      - name: UPSTASH_REDIS_REST_URL
        source: "Upstash Console -> Redis Database -> REST API section -> UPSTASH_REDIS_REST_URL"
      - name: UPSTASH_REDIS_REST_TOKEN
        source: "Upstash Console -> Redis Database -> REST API section -> UPSTASH_REDIS_REST_TOKEN"
    dashboard_config:
      - task: "Create a Redis database"
        location: "https://console.upstash.com -> Create Database -> select us-east-1 region"

must_haves:
  truths:
    - "Next.js project runs locally with npm run dev"
    - "PostgreSQL schema defines users, accounts, and session_metadata tables"
    - "Redis client connects to Upstash and can set/get/expire keys"
    - "Environment variables are validated at import time with Zod"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle table definitions for users, accounts, session_metadata"
      contains: "pgTable"
    - path: "src/lib/db/index.ts"
      provides: "Drizzle client instance connected to Neon"
      contains: "drizzle"
    - path: "src/lib/redis.ts"
      provides: "Upstash Redis client instance"
      contains: "Redis"
    - path: "src/lib/session-store.ts"
      provides: "Session state helpers with TTL"
      contains: "SESSION_TTL"
    - path: "src/lib/env.ts"
      provides: "Zod-validated environment variables"
      contains: "envSchema"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit migration configuration"
      contains: "defineConfig"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "schema import"
      pattern: "import.*schema"
    - from: "src/lib/session-store.ts"
      to: "src/lib/redis.ts"
      via: "redis client import"
      pattern: "import.*redis"
    - from: "src/lib/db/index.ts"
      to: "@neondatabase/serverless"
      via: "neon driver"
      pattern: "neon\\(.*DATABASE_URL"
---

<objective>
Scaffold the Next.js 16 project with all dependencies, create the PostgreSQL schema via Drizzle ORM, set up the Upstash Redis session store, and validate environment variables with Zod.

Purpose: Establish the foundational data layer that all subsequent phases build upon -- database tables, Redis connectivity, and project structure.
Output: A running Next.js 16 project with Drizzle schema, Redis client, session store helpers, and validated env config.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffolding-data-layer/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 16 project and install all Phase 1 dependencies</name>
  <files>
    package.json
    tsconfig.json
    src/app/layout.tsx
    src/app/page.tsx
    src/app/globals.css
    .env.local
    .env.example
    .gitignore
  </files>
  <action>
    Create the Next.js 16 project using create-next-app in the current directory (the repo root is empty except for .planning/ and .git/). Run:

    npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --turbopack --import-alias "@/*" --yes

    IMPORTANT: Use `.` as the project path since we are already in the repo root. The `--yes` flag skips prompts.

    After scaffolding, install Phase 1 dependencies:

    ```bash
    # Data layer
    npm install drizzle-orm@0.45.1 @neondatabase/serverless@1.0.2 @upstash/redis

    # Auth (needed by Plan 02, install now to avoid re-running npm install)
    npm install next-auth@beta @auth/drizzle-adapter bcryptjs

    # Validation
    npm install zod@4.3.6

    # Dev dependencies
    npm install -D drizzle-kit @types/bcryptjs
    ```

    Update `src/app/globals.css` to include the pink wellness theme tokens using Tailwind CSS 4 @theme directive:

    ```css
    @import "tailwindcss";

    @theme {
      --color-blush: #F8C8DC;
      --color-rose: #D63384;
      --color-charcoal: #2B2B2B;
      --color-cream: #FFF5F7;
    }
    ```

    Update `src/app/page.tsx` to a minimal placeholder page (remove the default Next.js boilerplate) that just shows "Wellness & Sensory Connection Assistant" in charcoal text on a cream background.

    Create `.env.example` with all required env var names (no values):

    ```
    DATABASE_URL=
    DATABASE_URL_UNPOOLED=
    UPSTASH_REDIS_REST_URL=
    UPSTASH_REDIS_REST_TOKEN=
    AUTH_SECRET=
    AUTH_URL=http://localhost:3000
    ```

    Create `.env.local` with the same structure but with placeholder comments explaining where to get each value. Generate AUTH_SECRET using `npx auth secret` or `openssl rand -base64 32`.

    Ensure `.gitignore` includes `.env.local` and `node_modules/` (create-next-app should handle this, but verify).
  </action>
  <verify>
    Run `npm run dev` and confirm the app starts on http://localhost:3000 without errors. Run `npx tsc --noEmit` to verify TypeScript compiles. Verify all packages are in package.json with `npm ls drizzle-orm @neondatabase/serverless @upstash/redis next-auth zod bcryptjs`.
  </verify>
  <done>
    Next.js 16 project runs locally. All Phase 1 dependencies installed. Tailwind CSS 4 configured with pink wellness theme tokens. .env.example documents all required variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle schema, database client, Redis client, session store, and env validation</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/index.ts
    src/lib/redis.ts
    src/lib/session-store.ts
    src/lib/env.ts
    src/types/index.ts
    drizzle.config.ts
  </files>
  <action>
    Create `src/lib/env.ts` -- Zod schema validating all required environment variables. Parse process.env at import time. Include DATABASE_URL, DATABASE_URL_UNPOOLED (optional), UPSTASH_REDIS_REST_URL, UPSTASH_REDIS_REST_TOKEN, AUTH_SECRET, AUTH_URL (optional, defaults to http://localhost:3000), NODE_ENV (default "development"). Fail fast with descriptive error if any required var is missing.

    Create `src/lib/db/schema.ts` -- Drizzle ORM table definitions following the research patterns exactly:
    - `usersTable`: uuid PK (defaultRandom), name (varchar 255), email (varchar 255, notNull, unique), emailVerified (timestamp), image (text), passwordHash (text), createdAt (timestamp, defaultNow, notNull), updatedAt (timestamp, defaultNow, notNull)
    - `accountsTable`: Auth.js required accounts table with composite PK on (provider, providerAccountId), userId FK to usersTable with cascade delete
    - `sessionMetadataTable`: uuid PK, userId FK to usersTable with cascade delete, startedAt (timestamp, defaultNow), endedAt (timestamp, nullable), durationSeconds (integer, nullable)

    Use imports from "drizzle-orm/pg-core": pgTable, text, timestamp, varchar, uuid, integer, primaryKey.

    Create `src/lib/db/index.ts` -- Drizzle client using Neon HTTP driver. Import neon from @neondatabase/serverless, drizzle from drizzle-orm/neon-http, and all schema. Use process.env.DATABASE_URL directly (not env.ts import to avoid circular deps with Auth.js loading order).

    Create `drizzle.config.ts` -- Drizzle Kit config using defineConfig. Schema path: "./src/lib/db/schema.ts". Dialect: "postgresql". DB credentials url: process.env.DATABASE_URL! (in production, use DATABASE_URL_UNPOOLED for migrations). Output dir: "./drizzle".

    Create `src/lib/redis.ts` -- Upstash Redis client instance. Import Redis from @upstash/redis. Create and export redis instance using process.env.UPSTASH_REDIS_REST_URL and process.env.UPSTASH_REDIS_REST_TOKEN.

    Create `src/lib/session-store.ts` -- Redis session state helpers with TTL. Import redis from ./redis. Define SessionState interface with userId (string), createdAt (number). Define SESSION_TTL = 3600 (1 hour). Export functions:
    - getSessionState(sessionId: string): Promise<SessionState | null> -- redis.get with key prefix "session:"
    - setSessionState(sessionId: string, state: SessionState): Promise<void> -- redis.set with { ex: SESSION_TTL }
    - deleteSessionState(sessionId: string): Promise<void> -- redis.del
    - refreshSessionTTL(sessionId: string): Promise<void> -- redis.expire with SESSION_TTL

    Create `src/types/index.ts` -- Shared TypeScript types. Export SessionState type (re-exported from session-store or duplicated). Add any type augmentations needed for Auth.js (extend the Session and JWT types to include user.id as string).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all TypeScript compiles without errors. Run `npx drizzle-kit generate` to verify Drizzle can read the schema and generate migration SQL (this should produce files in ./drizzle/). Verify the generated SQL creates the expected tables (users, accounts, session_metadata).
  </verify>
  <done>
    Drizzle schema defines users, accounts, and session_metadata tables. Database client connects to Neon via HTTP driver. Redis client and session store helpers exist with TTL support. Environment variables are validated with Zod at import time. drizzle-kit can generate migrations from the schema.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors on localhost:3000
2. `npx tsc --noEmit` passes with zero errors
3. `npx drizzle-kit generate` produces migration SQL for users, accounts, session_metadata tables
4. All required packages present in package.json
5. .env.example documents all required environment variables
6. Theme tokens (blush, rose, charcoal, cream) are defined in globals.css
</verification>

<success_criteria>
- Next.js 16 project scaffolded with TypeScript, Tailwind CSS 4, App Router, src directory
- PostgreSQL schema has users (with passwordHash), accounts, and session_metadata tables
- Redis client and session store with TTL helpers are ready for use
- Environment variables validated with Zod
- Drizzle migrations can be generated from schema
- All Phase 1 npm dependencies installed
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-scaffolding-data-layer/01-01-SUMMARY.md`
</output>
