---
phase: 01-project-scaffolding-data-layer
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/lib/auth.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - src/actions/auth.ts
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/register/page.tsx
  - src/app/(protected)/dashboard/page.tsx
  - src/components/auth/login-form.tsx
  - src/components/auth/register-form.tsx
  - src/proxy.ts
autonomous: true
requirements:
  - INFR-01
  - INFR-02

must_haves:
  truths:
    - "User can create an account with email and password via the register page"
    - "User can log in with valid credentials via the login page"
    - "User session persists across browser refresh without re-authentication"
    - "Unauthenticated users are redirected from protected pages to login"
    - "Authenticated users are redirected from login/register to dashboard"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Auth.js v5 configuration with Credentials provider and JWT strategy"
      exports: ["auth", "signIn", "signOut", "handlers"]
      contains: "NextAuth"
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js API route handler"
      exports: ["GET", "POST"]
    - path: "src/actions/auth.ts"
      provides: "Server actions for sign-up and sign-in"
      exports: ["signUp", "signInAction"]
    - path: "src/proxy.ts"
      provides: "Route protection via optimistic cookie check"
      contains: "proxy"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with form"
    - path: "src/app/(auth)/register/page.tsx"
      provides: "Registration page with form"
    - path: "src/app/(protected)/dashboard/page.tsx"
      provides: "Protected dashboard page with auth() verification"
      contains: "auth()"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/db/schema.ts"
      via: "imports usersTable for credential verification"
      pattern: "import.*usersTable.*schema"
    - from: "src/lib/auth.ts"
      to: "src/lib/db/index.ts"
      via: "imports db for queries and DrizzleAdapter"
      pattern: "import.*db.*from"
    - from: "src/actions/auth.ts"
      to: "src/lib/db/schema.ts"
      via: "imports usersTable for user creation"
      pattern: "import.*usersTable"
    - from: "src/actions/auth.ts"
      to: "src/lib/auth.ts"
      via: "imports signIn for post-registration login"
      pattern: "import.*signIn"
    - from: "src/proxy.ts"
      to: "authjs.session-token cookie"
      via: "optimistic cookie check for route protection"
      pattern: "session-token"
    - from: "src/app/(protected)/dashboard/page.tsx"
      to: "src/lib/auth.ts"
      via: "server-side session verification"
      pattern: "import.*auth.*from"
    - from: "src/components/auth/login-form.tsx"
      to: "src/actions/auth.ts"
      via: "form action calling signInAction"
      pattern: "signInAction"
    - from: "src/components/auth/register-form.tsx"
      to: "src/actions/auth.ts"
      via: "form action calling signUp"
      pattern: "signUp"
---

<objective>
Implement Auth.js v5 authentication with Credentials provider, sign-up/sign-in flows, route protection, and a protected dashboard page.

Purpose: Enable users to create accounts and log in with persistent sessions, satisfying the foundational auth requirements before any session content features are built.
Output: Working registration, login, logout, and route protection with JWT-based session persistence.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffolding-data-layer/01-RESEARCH.md
@.planning/phases/01-project-scaffolding-data-layer/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Auth.js v5 with Credentials provider, JWT strategy, and API route handler</name>
  <files>
    src/lib/auth.ts
    src/app/api/auth/[...nextauth]/route.ts
    src/actions/auth.ts
  </files>
  <action>
    Create `src/lib/auth.ts` -- Auth.js v5 configuration. Follow the research pattern exactly:
    - Import NextAuth from "next-auth", Credentials from "next-auth/providers/credentials", DrizzleAdapter from "@auth/drizzle-adapter"
    - Import db from "@/lib/db" and usersTable from "@/lib/db/schema"
    - Import eq from "drizzle-orm" and bcrypt from "bcryptjs"
    - Import z from "zod" (for Zod 4, use z.string() etc. -- API is the same)
    - Define credentialsSchema with z.object({ email: z.string().email(), password: z.string().min(8) })
    - Configure NextAuth with:
      - adapter: DrizzleAdapter(db)
      - session: { strategy: "jwt" } -- MUST use JWT with Credentials provider (database strategy causes null sessions)
      - providers: [Credentials({ credentials: { email: { type: "email" }, password: { type: "password" } }, authorize: async (credentials) => { validate with Zod, query usersTable by email, compare password with bcrypt.compare, return user or null } })]
      - pages: { signIn: "/login" }
      - callbacks: { jwt: add user.id to token, session: add token.id to session.user.id }
    - Export { handlers, auth, signIn, signOut }

    CRITICAL: The authorize callback must parse credentials with Zod BEFORE any database queries. Return null (not throw) for invalid credentials.

    Create `src/app/api/auth/[...nextauth]/route.ts` -- Auth.js route handler:
    ```typescript
    import { handlers } from "@/lib/auth";
    export const { GET, POST } = handlers;
    ```

    Create `src/actions/auth.ts` -- Server actions for registration and sign-in:

    **signUp(formData: FormData):**
    - "use server" directive at top of file
    - Validate with Zod: name (string, min 2, max 100), email (string, email), password (string, min 8, max 128)
    - Check if user already exists by email
    - Hash password with bcrypt.hash(password, 12)
    - Insert into usersTable with db.insert()
    - Return { success: true } or { error: string }

    **signInAction(formData: FormData):**
    - "use server" directive
    - Import signIn from "@/lib/auth"
    - Extract email and password from formData
    - Call signIn("credentials", { email, password, redirectTo: "/dashboard" })
    - Wrap in try/catch -- Auth.js throws a NEXT_REDIRECT on success (which is expected), and an AuthError on failure
    - On AuthError, return { error: "Invalid credentials" }
    - IMPORTANT: The signIn function from Auth.js will throw a redirect on success. You need to re-throw that redirect. Check if the error is an instance of AuthError from "next-auth" -- if not, re-throw it.

    **signOutAction():**
    - "use server" directive
    - Import signOut from "@/lib/auth"
    - Call signOut({ redirectTo: "/login" })
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all TypeScript compiles. Verify the auth.ts file exports auth, signIn, signOut, handlers. Verify the route handler exports GET and POST. Verify actions/auth.ts exports signUp, signInAction, signOutAction with "use server" directive.
  </verify>
  <done>
    Auth.js v5 configured with Credentials provider and JWT session strategy. Sign-up server action creates users with bcryptjs-hashed passwords. Sign-in server action authenticates via Auth.js. API route handler is registered at /api/auth/*.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login/register pages, protected dashboard, and route protection via proxy.ts</name>
  <files>
    src/app/(auth)/login/page.tsx
    src/app/(auth)/register/page.tsx
    src/app/(protected)/dashboard/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/register-form.tsx
    src/proxy.ts
  </files>
  <action>
    Create `src/proxy.ts` -- Next.js 16 route protection (replaces middleware.ts):
    - Export default function proxy(request: NextRequest)
    - Check for session cookie: "authjs.session-token" OR "__Secure-authjs.session-token" (the latter is used in production with HTTPS)
    - If pathname starts with "/dashboard" and no session cookie: redirect to /login
    - If pathname is "/login" or "/register" and session cookie exists: redirect to /dashboard
    - Otherwise: NextResponse.next()
    - Export config with matcher: ["/dashboard/:path*", "/login", "/register"]

    Create `src/components/auth/login-form.tsx` -- Client component ("use client"):
    - Import signInAction from "@/actions/auth"
    - Form with email input (type="email", required), password input (type="password", required, minLength=8), submit button
    - Use useActionState (from "react") to handle form submission and display errors
    - Show error message if signInAction returns { error: string }
    - Style with Tailwind: centered card on cream background, rose-colored submit button, charcoal text
    - Include link to "/register" ("Don't have an account? Register")

    Create `src/components/auth/register-form.tsx` -- Client component ("use client"):
    - Import signUp from "@/actions/auth"
    - Form with name input, email input, password input, submit button
    - Use useActionState to handle form submission
    - On success (signUp returns { success: true }), redirect to /login using useRouter or show success message
    - Show error message if signUp returns { error: string }
    - Style matching login-form: centered card, rose button, charcoal text
    - Include link to "/login" ("Already have an account? Log in")

    Create `src/app/(auth)/login/page.tsx` -- Server component:
    - Import and render LoginForm component
    - Minimal page layout: centered content, cream background

    Create `src/app/(auth)/register/page.tsx` -- Server component:
    - Import and render RegisterForm component
    - Minimal page layout matching login

    Create `src/app/(protected)/dashboard/page.tsx` -- Server component:
    - Import auth from "@/lib/auth" and redirect from "next/navigation"
    - Call const session = await auth() -- this is the ACTUAL session verification (proxy.ts only does optimistic redirect)
    - If !session, redirect("/login")
    - Display welcome message with session.user.name or session.user.email
    - Include a sign-out button/form that calls signOutAction
    - Style: cream background, charcoal text, rose accent for sign-out button

    Update `src/app/page.tsx` (root page):
    - Add links to /login and /register
    - Keep it minimal: app name + auth navigation links
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles. Run `npm run build` to verify the full production build succeeds (this catches proxy.ts config issues, route group errors, and server/client component boundary issues). Run `npm run dev` and manually verify:
    1. Visit /dashboard -- should redirect to /login
    2. Visit /register -- should show registration form
    3. Visit /login -- should show login form
    Note: Full flow testing (actual registration + login) requires database connection, which depends on user providing Neon credentials.
  </verify>
  <done>
    Login and register pages render with styled forms. Protected dashboard redirects unauthenticated users to login. Authenticated users on /login or /register are redirected to dashboard. proxy.ts provides optimistic route protection. Dashboard verifies session server-side with auth() and displays user info with sign-out button.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with zero errors
2. `npx tsc --noEmit` passes
3. /dashboard redirects to /login when not authenticated
4. /login shows a styled login form with email and password fields
5. /register shows a styled registration form with name, email, and password fields
6. proxy.ts is properly configured with route matcher
7. Auth.js API route handler responds at /api/auth/*
</verification>

<success_criteria>
- User can navigate to /register and see a registration form
- User can navigate to /login and see a login form
- Unauthenticated access to /dashboard redirects to /login
- Auth.js v5 is configured with Credentials provider, JWT strategy, and Drizzle adapter
- Sign-up server action validates input, hashes password, and inserts user
- Sign-in server action authenticates via Auth.js and redirects to dashboard
- Session persists via JWT httpOnly cookie (verified by auth() server-side)
- Full production build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-scaffolding-data-layer/01-02-SUMMARY.md`
</output>
