---
phase: 07-session-ux-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ws/message-types.ts
  - src/lib/ws/session-handler.ts
  - src/hooks/use-session-ws.ts
  - src/components/session/pre-session-flow.tsx
autonomous: true
requirements: [UI-06, UI-07, SESS-03]

must_haves:
  truths:
    - "User can select session length (10/15/20/30 minutes) before starting a session"
    - "Selected session length is transmitted to the server and used by the orchestrator"
    - "Consent flow is presented conversationally (not as a clinical modal)"
    - "AI disclosure and sensory consent are woven into the pre-session flow"
  artifacts:
    - path: "src/components/session/pre-session-flow.tsx"
      provides: "Multi-step pre-session flow (length selection, conversational consent, begin)"
      min_lines: 80
    - path: "src/lib/ws/message-types.ts"
      provides: "Extended start_session message with sessionLength field"
      contains: "sessionLength"
    - path: "src/lib/ws/session-handler.ts"
      provides: "Server reads sessionLength from client message and passes to orchestrator"
      contains: "sessionLength"
    - path: "src/hooks/use-session-ws.ts"
      provides: "startSession accepts sessionLength option"
      contains: "sessionLength"
  key_links:
    - from: "src/components/session/pre-session-flow.tsx"
      to: "src/hooks/use-session-ws.ts"
      via: "onBegin callback receives selectedLength"
      pattern: "sessionLength"
    - from: "src/hooks/use-session-ws.ts"
      to: "src/lib/ws/message-types.ts"
      via: "start_session message includes sessionLength"
      pattern: "sessionLength"
    - from: "src/lib/ws/session-handler.ts"
      to: "SessionOrchestrator"
      via: "Passes sessionLength from parsed client message to constructor"
      pattern: "sessionLengthMinutes.*sessionLength"
---

<objective>
Extend the WebSocket protocol to support client-selected session length, and build the multi-step pre-session flow component that replaces the simple "Begin Session" button with session length selection and conversational consent.

Purpose: Users choose their session duration before starting, and encounter consent as a natural conversational step rather than a clinical modal. The server-side orchestrator receives the selected length to calculate correct phase budgets.

Output: Extended message protocol, updated hook, and a standalone PreSessionFlow component ready for integration.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-session-ux-controls/07-RESEARCH.md
@src/lib/ws/message-types.ts
@src/lib/ws/session-handler.ts
@src/hooks/use-session-ws.ts
@src/components/consent/sensory-consent.tsx
@src/lib/consent/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend WebSocket protocol and hook for session length</name>
  <files>
    src/lib/ws/message-types.ts
    src/lib/ws/session-handler.ts
    src/hooks/use-session-ws.ts
  </files>
  <action>
    **message-types.ts:**
    1. Extend the `start_session` variant of `ClientMessage` to include `sessionLength?: number`
    2. In `parseClientMessage`, under the `case "start_session":` block, extract `sessionLength`:
       ```typescript
       case "start_session": {
         const sessionLength = typeof obj.sessionLength === "number" ? obj.sessionLength : undefined;
         return {
           type: "start_session",
           prompt: typeof obj.prompt === "string" ? obj.prompt : undefined,
           sessionLength,
         };
       }
       ```

    **session-handler.ts:**
    1. In the `case "start_session":` handler, read `message.sessionLength` and validate it:
       ```typescript
       const VALID_LENGTHS = [10, 15, 20, 30];
       const sessionLength = message.sessionLength && VALID_LENGTHS.includes(message.sessionLength)
         ? message.sessionLength
         : 15;
       ```
    2. Replace the hardcoded `sessionLengthMinutes: 15` with `sessionLengthMinutes: sessionLength`
    3. Remove the `// Default; Phase 7 will add client-selected length` comment

    **use-session-ws.ts:**
    1. Update the `startSession` callback to accept an options object:
       ```typescript
       const startSession = useCallback((options?: { prompt?: string; sessionLength?: number }) => {
         if (wsRef.current?.readyState === WebSocket.OPEN) {
           wsRef.current.send(JSON.stringify({
             type: "start_session",
             prompt: options?.prompt,
             sessionLength: options?.sessionLength,
           }));
         }
       }, []);
       ```
       This changes the signature from `(prompt?: string)` to `(options?: { prompt?: string; sessionLength?: number })`. This is a breaking change to the call site in session-screen.tsx, but Plan 02 will update that file.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm type-checking passes for message-types.ts, session-handler.ts, and use-session-ws.ts. Expect the session-screen.tsx call site to have a type error since it still calls `startSession()` with no args -- this is expected and will be fixed in Plan 02.
  </verify>
  <done>
    start_session message type includes optional sessionLength field. parseClientMessage extracts it. session-handler validates it (must be 10/15/20/30, defaults to 15) and passes it to SessionOrchestrator. useSessionWebSocket.startSession accepts an options object with sessionLength.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build PreSessionFlow component with length selection and conversational consent</name>
  <files>
    src/components/session/pre-session-flow.tsx
  </files>
  <action>
    Create a new `PreSessionFlow` client component at `src/components/session/pre-session-flow.tsx`.

    **Component interface:**
    ```typescript
    interface PreSessionFlowProps {
      onBegin: (options: { sessionLength: number; sensoryConsent: boolean }) => void;
    }
    ```

    **Internal state:** A `step` state with type `"length" | "consent" | "ready"` starting at `"length"`. Also `selectedLength` (default 15) and `sensoryConsentGiven` (boolean).

    **Step 1 - Length Selection ("length"):**
    - Dark charcoal background matching session aesthetic (bg-charcoal)
    - Title: "Choose Your Session" in cream/80, text-lg
    - Subtitle: "How long would you like to relax?" in cream/50, text-sm
    - Four option buttons arranged in a 2x2 grid: 10, 15, 20, 30 minutes
    - Each button: rounded-xl, min-h-[56px], text showing "10 min" / "15 min" / "20 min" / "30 min"
    - Selected state: bg-rose text-white; unselected: bg-cream/10 text-cream/70 hover:bg-cream/15
    - 15 min pre-selected (default)
    - "Continue" button below the grid: bg-rose text-white rounded-lg py-3 w-full max-w-xs
    - Continue advances to step "consent"

    **Step 2 - Conversational Consent ("consent"):**
    - This is the KEY UX requirement (UI-06: "not clinical modal"). The tone must be warm, inviting, conversational.
    - Dark background (bg-charcoal) with BreathingOrb rendered at reduced opacity (isPlaying={false}) as ambient background element
    - Conversational text (NOT a form, NOT a checkbox):
      ```
      "Before we begin, I want you to know -- I'm an AI wellness guide, here to help you relax. This isn't therapy, just a moment of calm."
      ```
      (This satisfies the AI disclosure requirement from the existing AI_DISCLOSURE_TEXT but reworded conversationally)
    - Second paragraph:
      ```
      "This session may include body awareness and sensory guidance -- gentle attention to breath, physical sensations, and relaxation."
      ```
    - Two buttons:
      - Primary: "I'm ready to begin" (bg-rose text-white) -- calls `recordSensoryConsent` server action, sets `sensoryConsentGiven=true`, advances to onBegin
      - Secondary: "Skip sensory content" (text-cream/40 text-sm) -- sets `sensoryConsentGiven=false`, advances to onBegin
    - Call the existing `recordSensoryConsent` server action when user clicks "I'm ready to begin" to maintain the PostgreSQL audit trail. Import from `@/actions/consent`.
    - Use `useActionState` for the server action call (matching existing pattern in SensoryConsent component).
    - On success of either button, call `onBegin({ sessionLength: selectedLength, sensoryConsent: sensoryConsentGiven })`.

    **Styling notes:**
    - All text uses cream color variants (cream/80, cream/60, cream/40) on charcoal background
    - Smooth CSS transitions between steps (use opacity + translate, no Framer Motion needed)
    - Follow the minimal-chrome, voice-first aesthetic from Phase 6 decisions
    - The BreathingOrb in the consent step should NOT animate -- it's just ambient visual decoration
    - max-w-sm for text content containers to maintain readability on larger screens
  </action>
  <verify>
    Run `npx tsc --noEmit` focusing on the new component file. Verify it compiles. Visually inspect the component can be imported without errors: `import { PreSessionFlow } from "@/components/session/pre-session-flow"`.
  </verify>
  <done>
    PreSessionFlow component exists with two-step flow: length selection (10/15/20/30 min with 15 default) and conversational consent (warm AI disclosure + sensory consent woven in). Calls recordSensoryConsent server action for audit trail. Calls onBegin callback with selected length and consent status. Styled in voice-first dark aesthetic matching session screen.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all modified/created files (session-screen.tsx may have a type error from the changed startSession signature -- this is expected and resolved in Plan 02)
2. `start_session` ClientMessage type includes optional `sessionLength` field
3. `parseClientMessage` correctly extracts sessionLength from raw JSON
4. `session-handler.ts` validates sessionLength to allowed values [10, 15, 20, 30] and defaults to 15
5. `PreSessionFlow` component renders two steps (length selection, consent) and emits onBegin callback
</verification>

<success_criteria>
- WebSocket protocol extended with sessionLength on start_session message
- Server validates and uses client-selected session length for orchestrator
- PreSessionFlow standalone component complete with length selection and conversational consent
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/07-session-ux-controls/07-01-SUMMARY.md`
</output>
