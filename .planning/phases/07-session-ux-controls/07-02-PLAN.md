---
phase: 07-session-ux-controls
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/session/session-controls.tsx
  - src/components/session/phase-indicator.tsx
  - src/components/session/session-screen.tsx
autonomous: true
requirements: [UI-03, UI-04]

must_haves:
  truths:
    - "User can pause a session and audio stops"
    - "User can resume a paused session and audio continues"
    - "User can end a session at any time"
    - "User can see which of the 5 phases the session is currently in"
    - "Breathing orb stops animating when session is paused"
  artifacts:
    - path: "src/components/session/session-controls.tsx"
      provides: "Pause/resume toggle and end session controls"
      min_lines: 25
    - path: "src/components/session/phase-indicator.tsx"
      provides: "5-segment progress indicator for session phases"
      min_lines: 20
    - path: "src/components/session/session-screen.tsx"
      provides: "Integrated session screen with pre-session flow, controls, and progress"
      min_lines: 60
  key_links:
    - from: "src/components/session/session-screen.tsx"
      to: "src/components/session/pre-session-flow.tsx"
      via: "Renders PreSessionFlow in pre-session state, receives onBegin callback"
      pattern: "PreSessionFlow"
    - from: "src/components/session/session-screen.tsx"
      to: "src/hooks/use-session-ws.ts"
      via: "Destructures pause, resume, isPaused, currentPhase from hook"
      pattern: "pause.*resume.*isPaused.*currentPhase"
    - from: "src/components/session/session-controls.tsx"
      to: "src/components/session/session-screen.tsx"
      via: "Receives onPause, onResume, onEnd, isPaused props"
      pattern: "SessionControls"
    - from: "src/components/session/phase-indicator.tsx"
      to: "src/lib/session/phase-machine.ts"
      via: "Imports SESSION_PHASES for phase-to-index mapping"
      pattern: "SESSION_PHASES"
---

<objective>
Build playback controls and phase progress indicator components, then integrate all Phase 7 components into the session screen -- replacing the "Begin Session" button with PreSessionFlow, adding controls and progress to the active session view.

Purpose: Users gain full session control (pause/resume/end) and passive phase progress awareness while maintaining the voice-first minimal-chrome aesthetic.

Output: Two new components (SessionControls, PhaseIndicator) and a fully updated SessionScreen integrating all Phase 7 work.
</objective>

<execution_context>
@/Users/torbjorntest/.claude/get-shit-done/workflows/execute-plan.md
@/Users/torbjorntest/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-session-ux-controls/07-RESEARCH.md
@.planning/phases/07-session-ux-controls/07-01-SUMMARY.md
@src/components/session/session-screen.tsx
@src/components/session/breathing-orb.tsx
@src/hooks/use-session-ws.ts
@src/lib/session/phase-machine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionControls and PhaseIndicator components</name>
  <files>
    src/components/session/session-controls.tsx
    src/components/session/phase-indicator.tsx
  </files>
  <action>
    **session-controls.tsx:**
    Create a "use client" component for pause/resume/end controls.

    ```typescript
    interface SessionControlsProps {
      isPaused: boolean;
      onPause: () => void;
      onResume: () => void;
      onEnd: () => void;
    }
    ```

    Layout: A centered horizontal flex row at the bottom of the screen (positioned by parent).

    - **Pause/Resume toggle:** A single button that shows a pause icon (two vertical bars ▐▐) when playing, and a play icon (▶) when paused. Use simple Unicode or inline SVG. The button should be subtle: `text-cream/40 hover:text-cream/60 transition-colors`. Size: 44x44px touch target (min-h-[44px] min-w-[44px]) but visually small icon. When `isPaused` is true, show play icon and call `onResume`; when false, show pause icon and call `onPause`.
    - **End Session:** Keep the existing ultra-subtle style: `text-xs text-cream/30 hover:text-cream/60 transition-colors`. Text "End Session".
    - Arrange: pause/resume button centered, end session text below it. Vertical stack with gap-3.
    - The entire control group should feel minimal and non-distracting (matching Phase 6 design decision: "End Session button intentionally tiny/subtle for voice-first minimal chrome").

    **phase-indicator.tsx:**
    Create a "use client" component for the 5-phase progress display.

    ```typescript
    interface PhaseIndicatorProps {
      currentPhase: string | null;
    }
    ```

    - Import `SESSION_PHASES` from `@/lib/session/phase-machine` (this is safe for client -- it's a pure const array with no server dependencies)
    - Calculate `activeIndex` using `SESSION_PHASES.indexOf(currentPhase as SessionPhase)`, defaulting to -1 if null
    - Render 5 horizontal segments (thin rounded bars): `h-1 w-5 rounded-full transition-colors duration-500`
    - Completed phases (index <= activeIndex): `bg-blush` (pink, visible)
    - Future phases: `bg-cream/15` (barely visible)
    - Add `role="progressbar"` with `aria-valuenow={activeIndex + 1}` and `aria-valuemax={5}` and `aria-label="Session progress"`
    - Each segment gets a `title` attribute with the phase name capitalized (e.g., "Atmosphere", "Breathing")
    - The component is positioned by its parent (no absolute positioning in this component)
    - Very subtle -- should not draw attention from the voice experience
  </action>
  <verify>
    Run `npx tsc --noEmit` on the two new component files. Verify they compile without errors. Check that `phase-indicator.tsx` correctly imports from `@/lib/session/phase-machine`.
  </verify>
  <done>
    SessionControls component renders pause/resume toggle + end session with minimal-chrome styling and proper touch targets. PhaseIndicator component renders 5 segments mapping SESSION_PHASES to visual progress with accessibility attributes. Both components are standalone and ready for integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all Phase 7 components into SessionScreen</name>
  <files>
    src/components/session/session-screen.tsx
  </files>
  <action>
    Rewrite `session-screen.tsx` to integrate PreSessionFlow (from Plan 01), SessionControls, and PhaseIndicator.

    **New imports:**
    ```typescript
    import { PreSessionFlow } from "@/components/session/pre-session-flow";
    import { SessionControls } from "@/components/session/session-controls";
    import { PhaseIndicator } from "@/components/session/phase-indicator";
    ```

    **Updated hook destructuring:**
    Add `pause`, `resume`, `isPaused` to the existing destructured values from `useSessionWebSocket()`.

    **Updated state:**
    - Keep `hasInitiated` state
    - Add `selectedLength` state (number, default 15) to store the chosen session length
    - Add `sensoryConsent` state (boolean, default false) to track consent from pre-session flow

    **Pre-session screen (replaces current "Begin Session" button):**
    When `!hasInitiated`, render `<PreSessionFlow onBegin={handleBegin} />` instead of the current button layout.

    **handleBegin callback:**
    ```typescript
    const handleBegin = (options: { sessionLength: number; sensoryConsent: boolean }) => {
      setSelectedLength(options.sessionLength);
      setSensoryConsent(options.sensoryConsent);
      connect();
      setHasInitiated(true);
    };
    ```

    **Updated startSession call in useEffect:**
    Pass the selected length to startSession:
    ```typescript
    useEffect(() => {
      if (hasInitiated && isConnected && !sessionId) {
        startSession({ sessionLength: selectedLength });
      }
    }, [hasInitiated, isConnected, sessionId, startSession, selectedLength]);
    ```

    **Active session view updates:**
    1. Add PhaseIndicator at the top of the active session view:
       ```tsx
       <div className="absolute top-6 left-0 right-0 flex justify-center" style={{ paddingTop: "env(safe-area-inset-top)" }}>
         <PhaseIndicator currentPhase={currentPhase} />
       </div>
       ```

    2. Pass `isPaused` to BreathingOrb so it stops animating when paused:
       ```tsx
       <BreathingOrb isPlaying={isPlaying && !isPaused} />
       ```

    3. Replace the current "End Session" button with SessionControls:
       ```tsx
       <div className="absolute bottom-8 left-0 right-0 flex justify-center" style={{ paddingBottom: "env(safe-area-inset-bottom)" }}>
         <SessionControls
           isPaused={isPaused}
           onPause={pause}
           onResume={resume}
           onEnd={handleEnd}
         />
       </div>
       ```

    4. Remove the old standalone `<button onClick={handleEnd}>End Session</button>` -- it's now inside SessionControls.

    5. Keep the error banner, currentText overlay, and connecting state unchanged.

    **Important: Do NOT break existing patterns:**
    - Keep `connect()` in the gesture handler (browser autoplay policy compliance)
    - Keep `startSession()` in useEffect watching `isConnected` (WebSocket race condition prevention)
    - Keep the dark charcoal background and safe-area-padding
    - Keep the Link import for any navigation needs (though the "Back to Dashboard" link moves into PreSessionFlow or is removed since PreSessionFlow handles its own back navigation)
  </action>
  <verify>
    1. Run `npx tsc --noEmit` -- all files should compile cleanly with zero type errors
    2. Run `npm run build` (or `npx next build`) to verify the full application builds
    3. Verify the session page loads at /session without runtime errors
  </verify>
  <done>
    SessionScreen renders PreSessionFlow for the pre-session state (length selection + conversational consent). Active session shows PhaseIndicator at top, BreathingOrb (pauses animation when isPaused), current text, and SessionControls at bottom. startSession passes selected length to server via the extended hook. Full integration of all Phase 7 components complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors across all modified and new files
2. `npm run build` completes successfully
3. Session page (/session) loads and shows PreSessionFlow with length selection
4. Length selection shows 4 options (10/15/20/30) with 15 pre-selected
5. Consent step shows conversational text (not a clinical modal)
6. Active session shows phase progress indicator with 5 segments
7. Pause button pauses audio and stops orb animation
8. Resume button resumes audio and restarts orb animation
9. End session button ends session gracefully
10. Controls follow minimal-chrome aesthetic (subtle, not visually dominant)
</verification>

<success_criteria>
- User can pause, resume, and end sessions via UI controls
- Phase progress indicator shows current session phase with 5 visual segments
- Breathing orb stops animating when paused, resumes when unpaused
- All Phase 7 components integrated into session-screen.tsx
- Application builds and loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-session-ux-controls/07-02-SUMMARY.md`
</output>
